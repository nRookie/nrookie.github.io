


enable bin

``` 
vi /etc/my.cnf
[mysqld]
log_bin = mysql_bin
server-id = 1
#

```
``` mysql
show variables like 'log_%';

mysql> show master logs;
+------------------+-----------+
| Log_name         | File_size |
+------------------+-----------+
| mysql_bin.000001 |       154 |
+------------------+-----------+
```


``` mysql
mysql> show variables like '%binlog_format%';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| binlog_format | ROW   |
+---------------+-------+
1 row in set (0.00 sec)

set global binlog_format='STATEMENT';// 设置binlog模式 设置之后需要退出mysql重新连接就能看到已修改
```

statement：备库在执行主库的语句时执行结果可能不一致。原因：如果 where 条件中有多个索引，主备库在执行这条语句时，选择的索引可能不同，执行结果也就不同 row：由于记录的是修改的主键的 id，备库执行结果与主库一致


``` mysql
mysql> show binlog events in 'mysql_bin.000001';
+------------------+------+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Log_name         | Pos  | Event_type     | Server_id | End_log_pos | Info                                                                                                                                                                                                                          |
+------------------+------+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| mysql_bin.000001 |    4 | Format_desc    |         1 |         123 | Server ver: 5.7.34-log, Binlog ver: 4                                                                                                                                                                                         |
| mysql_bin.000001 |  123 | Previous_gtids |         1 |         154 |                                                                                                                                                                                                                               |
| mysql_bin.000001 |  154 | Anonymous_Gtid |         1 |         219 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 |  219 | Query          |         1 |         337 | use `testdb`; DROP TABLE `t` /* generated by server */                                                                                                                                                                        |
| mysql_bin.000001 |  337 | Anonymous_Gtid |         1 |         402 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 |  402 | Query          |         1 |         689 | use `testdb`; CREATE TABLE `t` ( `id` int(11) NOT NULL, `a` int(11) DEFAULT NULL, `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `a` (`a`), KEY `t_modified`(`t_modified`)) ENGINE=InnoDB |
| mysql_bin.000001 |  689 | Anonymous_Gtid |         1 |         754 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 |  754 | Query          |         1 |         872 | use `testdb`; DROP TABLE `t` /* generated by server */                                                                                                                                                                        |
| mysql_bin.000001 |  872 | Anonymous_Gtid |         1 |         937 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 |  937 | Query          |         1 |        1224 | use `testdb`; CREATE TABLE `t` ( `id` int(11) NOT NULL, `a` int(11) DEFAULT NULL, `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `a` (`a`), KEY `t_modified`(`t_modified`)) ENGINE=InnoDB |
| mysql_bin.000001 | 1224 | Anonymous_Gtid |         1 |        1289 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 1289 | Query          |         1 |        1371 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 1371 | Table_map      |         1 |        1420 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 1420 | Write_rows     |         1 |        1468 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 1468 | Xid            |         1 |        1499 | COMMIT /* xid=19 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 1499 | Anonymous_Gtid |         1 |        1564 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 1564 | Query          |         1 |        1646 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 1646 | Table_map      |         1 |        1695 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 1695 | Write_rows     |         1 |        1743 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 1743 | Xid            |         1 |        1774 | COMMIT /* xid=20 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 1774 | Anonymous_Gtid |         1 |        1839 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 1839 | Query          |         1 |        1921 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 1921 | Table_map      |         1 |        1970 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 1970 | Write_rows     |         1 |        2018 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 2018 | Xid            |         1 |        2049 | COMMIT /* xid=21 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 2049 | Anonymous_Gtid |         1 |        2114 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 2114 | Query          |         1 |        2196 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 2196 | Table_map      |         1 |        2245 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 2245 | Write_rows     |         1 |        2293 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 2293 | Xid            |         1 |        2324 | COMMIT /* xid=22 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 2324 | Anonymous_Gtid |         1 |        2389 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 2389 | Query          |         1 |        2471 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 2471 | Table_map      |         1 |        2520 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 2520 | Write_rows     |         1 |        2568 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 2568 | Xid            |         1 |        2599 | COMMIT /* xid=23 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 2599 | Anonymous_Gtid |         1 |        2664 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 2664 | Query          |         1 |        2746 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 2746 | Table_map      |         1 |        2795 | table_id: 112 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 2795 | Delete_rows    |         1 |        2843 | table_id: 112 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 2843 | Xid            |         1 |        2874 | COMMIT /* xid=24 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 2874 | Anonymous_Gtid |         1 |        2939 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 2939 | Query          |         1 |        3057 | use `testdb`; DROP TABLE `t` /* generated by server */                                                                                                                                                                        |
| mysql_bin.000001 | 3057 | Anonymous_Gtid |         1 |        3122 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 3122 | Query          |         1 |        3409 | use `testdb`; CREATE TABLE `t` ( `id` int(11) NOT NULL, `a` int(11) DEFAULT NULL, `t_modified` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP, PRIMARY KEY (`id`), KEY `a` (`a`), KEY `t_modified`(`t_modified`)) ENGINE=InnoDB |
| mysql_bin.000001 | 3409 | Anonymous_Gtid |         1 |        3474 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 3474 | Query          |         1 |        3556 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 3556 | Table_map      |         1 |        3605 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 3605 | Write_rows     |         1 |        3653 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 3653 | Xid            |         1 |        3684 | COMMIT /* xid=37 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 3684 | Anonymous_Gtid |         1 |        3749 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 3749 | Query          |         1 |        3831 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 3831 | Table_map      |         1 |        3880 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 3880 | Write_rows     |         1 |        3928 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 3928 | Xid            |         1 |        3959 | COMMIT /* xid=38 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 3959 | Anonymous_Gtid |         1 |        4024 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 4024 | Query          |         1 |        4106 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 4106 | Table_map      |         1 |        4155 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 4155 | Write_rows     |         1 |        4203 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 4203 | Xid            |         1 |        4234 | COMMIT /* xid=39 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 4234 | Anonymous_Gtid |         1 |        4299 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 4299 | Query          |         1 |        4381 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 4381 | Table_map      |         1 |        4430 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 4430 | Write_rows     |         1 |        4478 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 4478 | Xid            |         1 |        4509 | COMMIT /* xid=40 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 4509 | Anonymous_Gtid |         1 |        4574 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 4574 | Query          |         1 |        4656 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 4656 | Table_map      |         1 |        4705 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 4705 | Write_rows     |         1 |        4753 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 4753 | Xid            |         1 |        4784 | COMMIT /* xid=41 */                                                                                                                                                                                                           |
| mysql_bin.000001 | 4784 | Anonymous_Gtid |         1 |        4849 | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'                                                                                                                                                                                          |
| mysql_bin.000001 | 4849 | Query          |         1 |        4931 | BEGIN                                                                                                                                                                                                                         |
| mysql_bin.000001 | 4931 | Table_map      |         1 |        4980 | table_id: 114 (testdb.t)                                                                                                                                                                                                      |
| mysql_bin.000001 | 4980 | Delete_rows    |         1 |        5028 | table_id: 114 flags: STMT_END_F                                                                                                                                                                                               |
| mysql_bin.000001 | 5028 | Xid            |         1 |        5059 | COMMIT /* xid=42 */                                                                                                                                                                                                           |
+------------------+------+----------------+-----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

```


``` mysql bin log

[root@primary ~]# mysqlbinlog  -vv /var/lib/mysql/mysql_bin.000001  --start-position=8900
/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/;
/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/;
DELIMITER /*!*/;
# at 4
#220202 19:33:16 server id 1  end_log_pos 123 CRC32 0x0f038270 	Start: binlog v 4, server v 5.7.34-log created 220202 19:33:16 at startup
# Warning: this binlog is either in use or was not closed properly.
ROLLBACK/*!*/;
BINLOG '
/Gv6YQ8BAAAAdwAAAHsAAAABAAQANS43LjM0LWxvZwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
AAAAAAAAAAAAAAAAAAD8a/phEzgNAAgAEgAEBAQEEgAAXwAEGggAAAAICAgCAAAACgoKKioAEjQA
AXCCAw8=
'/*!*/;
SET @@SESSION.GTID_NEXT= 'AUTOMATIC' /* added by mysqlbinlog */ /*!*/;
DELIMITER ;
# End of log file
/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;
/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;
```

当然我要说的是，现在越来越多的场景要求把 MySQL 的 binlog 格式设置成 row。这么做的理由有很多，我来给你举一个可以直接看出来的好处：恢复数据。

所以，用 binlog 来恢复数据的标准做法是，用 mysqlbinlog 工具解析出来，然后把解析结果整个发给 MySQL 执行。类似下面的命令：

``` mysql
mysqlbinlog master.000001 --start-position=2738 --stop-position=2973 | mysql -h127.0.0.1 -P13000 -u$user -p$pwd;这个命
```
令的意思是，将 master.000001 文件里面从第 2738 字节到第 2973 字节中间这段内容解析出来，放到 MySQL 去执行。

